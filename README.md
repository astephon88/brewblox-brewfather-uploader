# Brewblox Service for Uploading Metrics to Brewfather

[Brewfather](https://brewfather.app/) is online brewing software for managing recipes and batches. It includes the ability to upload fermentation metrics such as gravity and temperature

[Brewblox](https://brewblox.netlify.app) is a modular brewery control system design to work with the BrewPi Spark controller.

This service provides a way to upload metrics logged by Brewblox to Brewfather's Custom Stream feature

## Credits

This service borrows heavily from [robvdw2](https://github.com/robvdw2)'s [Uploader script](https://github.com/robvdw2/brewblox_to_brewfather).

## Usage

You need to create the `~/brewblox/brewfather-uploader` directory, and add the service to the `docker-compose.yml` file.

```bash
mkdir ~/brewblox/brewfather-uploader
```

```yaml
  brewfather-uploader:
    image: astephon88/brewblox-brewfather-uploader:develop
    restart: unless-stopped
    volumes: ['./brewfather-uploader:/config']
    command: --brewfather-url=http://log.brewfather.net/stream?id=XXXXXXXXXXXXXX
```
The `brewfather-url` argument is the url provided by brewfather when enabling a [custom stream](https://docs.brewfather.app/integrations/custom-stream).

Create the `~/brewblox/brewfather-uploader/ermenter_config.yml' file which will contain the mapping from Brewblox sensor to Brewfather field. The following is an example.

```yaml
- name: "Fermenter 1"
  temp_unit: "F"
  gravity_unit: "G"
  sensors:
    temp:
      service_type: "spark"
      service: "spark-one"
      sensor: "Fermenter 1 Beer Sensor"
    gravity:
      service_type: "tilt"
      tilt_params:
        calibrated: True
      service: "tilt"
      sensor: "Blue"
- name: "Fermenter 2"
  temp_unit: "F"
  gravity_unit: "G"
  sensors:
    temp:
      service_type: "spark-one"
      service: "cold-side"
      sensor: "Fermenter 2 Beer Sensor"
    gravity:
      service_type: "tilt"
      tilt_params:
        calibrated: True
      service: "tilt"
      sensor: "Orange"
```

The config file format is fairly self explanitory. There is a list item for each fermerter you would like to upload metrics. The keys in the `sensors` dictionary are the keys that Brewfather is expecting. Each sensor has required `service-type`, `service`, and `sensor` keys. The `tilt_params` key is for tilt-specific configuration parameters. `calibrated` is currently the only option, and specifies if the Calibrated metrics generated by the tilt service should be used.

Finally, you'll have to bring up the new service using

```bash
brewblox-ctl up
```

## Limitations

The service currently only supports the `temp` and `gravity` fields from the Brewfather custom stream data structure. `aux_temp`, `ext_temp`, and `bpm` could easily be added. The other measurements do not have any sensors currently available in Brewblox to generate them.

The `temp` metric is currently only supported by Spark and Tilt temperature sensors. The `gravity` metric is only supported for Tilt. The service will eventually be expanded to support Plaato airlocks.
